## 1. çº¿ç¨‹çŠ¶æ€

é¢è¯•é¢˜ï¼šçº¿ç¨‹æœ‰å“ªäº›çŠ¶æ€ï¼Ÿ

**è¦æ±‚**

* æŒæ¡ Java çº¿ç¨‹å…­ç§çŠ¶æ€
* æŒæ¡ Java çº¿ç¨‹çŠ¶æ€è½¬æ¢
* èƒ½ç†è§£äº”ç§çŠ¶æ€ä¸å…­ç§çŠ¶æ€ä¸¤ç§è¯´æ³•çš„åŒºåˆ«

![](/assets/img/ext-img/çº¿ç¨‹6ç§çŠ¶æ€.jpg)

`æ–°å»ºâ€”â€”>å¯è¿è¡Œ`å½“çº¿ç¨‹newä¸€ä¸ªæ—¶ï¼Œè¿˜æ˜¯ä¸ªJavaå¯¹è±¡ï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰å’Œæ“ä½œç³»ç»Ÿåº•å±‚çœŸæ­£çš„çº¿ç¨‹å…³è”èµ·æ¥ï¼Œæ­¤æ—¶ä»…æ˜¯ä¸ªJavaå¯¹è±¡ï¼Œå½“Javaå¯¹è±¡è°ƒç”¨äº†çº¿ç¨‹çš„start()æ—¶ï¼Œä¼šå˜æˆå¯è¿è¡ŒçŠ¶æ€ï¼Œæ­¤å˜äº†å¯è¿è¡ŒçŠ¶æ€åï¼Œæ‰ä¼šä¸çœŸæ­£çš„çº¿ç¨‹å…³è”èµ·æ¥ã€‚é‡Œé¢çš„ä»£ç ä¹Ÿä¼šç”±æ“ä½œç³»ç»Ÿäº¤ç»™cpuå»æ‰§è¡Œã€‚

`å¯è¿è¡Œâ€”â€”>ç­‰å¾…`äº‰æŠ¢é”æˆåŠŸäº†ï¼Œä½†æ˜¯è¿›æ¥å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè¿™æ—¶å€™è°ƒç”¨wait()æ–¹æ³•,æŒé”çº¿ç¨‹ä¼šè¿›å…¥åˆ°waittingçŠ¶æ€ï¼Œæƒ³ç­‰æ¡ä»¶æ»¡è¶³å†æ‰§è¡Œï¼Œä½†æ˜¯ä¸ä¼šä¸€ç›´å ç€é”ï¼Œåº”é‡Šæ”¾å¼€é”ï¼Œç»™å…¶ä»–çº¿ç¨‹å»ç«äº‰ã€‚

`ç­‰å¾…â€”â€”>å¯è¿è¡Œ`å½“ä¸€ä¸ªå¤„äº WAITING çŠ¶æ€çš„çº¿ç¨‹è¢«å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ notify() æ–¹æ³•åï¼Œè¯¥çº¿ç¨‹ä¼šä» WAITING çŠ¶æ€è½¬æ¢ä¸º BLOCKED çŠ¶æ€ï¼Œç­‰å¾…è·å¾—é”ã€‚

å¦‚æœè¯¥çº¿ç¨‹è·å¾—äº†é”ï¼Œåˆ™å®ƒä¼šä» BLOCKED çŠ¶æ€è½¬æ¢ä¸º RUNNABLE çŠ¶æ€ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚å¦‚æœè¯¥çº¿ç¨‹ä¾ç„¶æ— æ³•è·å¾—é”ï¼Œåˆ™å®ƒä¼šç»§ç»­ä¿æŒåœ¨ BLOCKED çŠ¶æ€ï¼Œç­‰å¾…è·å¾—é”ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹çš„çŠ¶æ€å°†ä¼šä¸€ç›´ä¿æŒä¸º BLOCKEDï¼Œç›´åˆ°å®ƒè·å¾—äº†é”æˆ–è€…ç­‰å¾…è¶…æ—¶å†è½¬æˆRUNNABLEçŠ¶æ€ã€‚



## 2.çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°

é¢è¯•é¢˜ï¼šçº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°ã€‚

**è¦æ±‚**

* æŒæ¡çº¿ç¨‹æ± çš„ 7 å¤§æ ¸å¿ƒå‚æ•°

**ä¸ƒå¤§å‚æ•°**

1. corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°ç›® - æ± ä¸­ä¼šä¿ç•™çš„æœ€å¤šçº¿ç¨‹æ•°
2. maximumPoolSize æœ€å¤§çº¿ç¨‹æ•°ç›® - æ ¸å¿ƒçº¿ç¨‹+æ•‘æ€¥çº¿ç¨‹çš„æœ€å¤§æ•°ç›®
3. keepAliveTime ç”Ÿå­˜æ—¶é—´ - æ•‘æ€¥çº¿ç¨‹çš„ç”Ÿå­˜æ—¶é—´ï¼Œç”Ÿå­˜æ—¶é—´å†…æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œæ­¤çº¿ç¨‹èµ„æºä¼šé‡Šæ”¾
4. unit æ—¶é—´å•ä½ - æ•‘æ€¥çº¿ç¨‹çš„ç”Ÿå­˜æ—¶é—´å•ä½ï¼Œå¦‚ç§’ã€æ¯«ç§’ç­‰
5. workQueue - å½“æ²¡æœ‰ç©ºé—²æ ¸å¿ƒçº¿ç¨‹æ—¶ï¼Œæ–°æ¥ä»»åŠ¡ä¼šåŠ å…¥åˆ°æ­¤é˜Ÿåˆ—æ’é˜Ÿï¼Œé˜Ÿåˆ—æ»¡ä¼šåˆ›å»ºæ•‘æ€¥çº¿ç¨‹æ‰§è¡Œä»»åŠ¡
6. threadFactory çº¿ç¨‹å·¥å‚ - å¯ä»¥å®šåˆ¶çº¿ç¨‹å¯¹è±¡çš„åˆ›å»ºï¼Œä¾‹å¦‚è®¾ç½®çº¿ç¨‹åå­—ã€æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹ç­‰
7. handler æ‹’ç»ç­–ç•¥ - å½“æ‰€æœ‰çº¿ç¨‹éƒ½åœ¨ç¹å¿™ï¼ŒworkQueue ä¹Ÿæ”¾æ»¡æ—¶ï¼Œä¼šè§¦å‘æ‹’ç»ç­–ç•¥
   1. æŠ›å¼‚å¸¸ java.util.concurrent.ThreadPoolExecutor.AbortPolicy
   2. ç”±è°ƒç”¨è€…æ‰§è¡Œä»»åŠ¡ java.util.concurrent.ThreadPoolExecutor.CallerRunsPolicy
   3. ä¸¢å¼ƒä»»åŠ¡ java.util.concurrent.ThreadPoolExecutor.DiscardPolicy
   4. ä¸¢å¼ƒæœ€æ—©æ’é˜Ÿä»»åŠ¡ java.util.concurrent.ThreadPoolExecutor.DiscardOldestPolicy

![](/assets/img/ext-img/çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°.jpg)

>[ä»£ç ç¤ºä¾‹ğŸ‘ˆ](https://github.com/Fengleitown/BLOG-code/tree/main/src/main/java/day02)![](https://badgen.net/github/stars/Fengleitown/fengleitown.github.io?icon=github&color=4ab8a1)ä¸­TestThreadPoolExecutorï¼ŒTestThreadStateç±»

## 3. wait vs sleep
é¢è¯•é¢˜ï¼šå¯¹æ¯”sleepå’Œwaitæ–¹æ³•ã€‚

**è¦æ±‚**

* èƒ½å¤Ÿè¯´å‡ºäºŒè€…åŒºåˆ«

**ä¸€ä¸ªå…±åŒç‚¹ï¼Œä¸‰ä¸ªä¸åŒç‚¹**

å…±åŒç‚¹

* wait() ï¼Œwait(long) å’Œ sleep(long) çš„æ•ˆæœéƒ½æ˜¯è®©å½“å‰çº¿ç¨‹æš‚æ—¶æ”¾å¼ƒ CPU çš„ä½¿ç”¨æƒï¼Œè¿›å…¥é˜»å¡çŠ¶æ€

ä¸åŒç‚¹

* æ–¹æ³•å½’å±ä¸åŒ
  * sleep(long) æ˜¯ Thread çš„é™æ€æ–¹æ³•
  * è€Œ wait()ï¼Œwait(long) éƒ½æ˜¯ Object çš„æˆå‘˜æ–¹æ³•ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰

* é†’æ¥æ—¶æœºä¸åŒ
  * æ‰§è¡Œ sleep(long) å’Œ wait(long) çš„çº¿ç¨‹éƒ½ä¼šåœ¨ç­‰å¾…ç›¸åº”æ¯«ç§’åé†’æ¥
  * wait(long) å’Œ wait() è¿˜å¯ä»¥è¢« notify å”¤é†’ï¼Œwait() å¦‚æœä¸å”¤é†’å°±ä¸€ç›´ç­‰ä¸‹å»
  * å®ƒä»¬éƒ½å¯ä»¥è¢«æ‰“æ–­å”¤é†’

* é”ç‰¹æ€§ä¸åŒï¼ˆé‡ç‚¹ï¼‰
  * wait æ–¹æ³•çš„è°ƒç”¨`å¿…é¡»å…ˆè·å– wait å¯¹è±¡çš„é”`ï¼Œè€Œ sleep åˆ™æ— æ­¤é™åˆ¶
  * wait æ–¹æ³•æ‰§è¡Œåä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œå…è®¸å…¶å®ƒçº¿ç¨‹è·å¾—è¯¥å¯¹è±¡é”ï¼ˆæˆ‘æ”¾å¼ƒ cpuï¼Œä½†ä½ ä»¬è¿˜å¯ä»¥ç”¨ï¼‰
  * è€Œ sleep å¦‚æœåœ¨ synchronized ä»£ç å—ä¸­æ‰§è¡Œï¼Œå¹¶ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼ˆæˆ‘æ”¾å¼ƒ cpuï¼Œä½ ä»¬ä¹Ÿç”¨ä¸äº†ï¼‰

>[ä»£ç ç¤ºä¾‹ğŸ‘ˆ](https://github.com/Fengleitown/BLOG-code/tree/main/src/main/java/day02)ä¸­WaitVsSleep

## 4.lock vs synchronized

é¢è¯•é¢˜ï¼šå¯¹æ¯”lock å’Œ synchronized

**è¦æ±‚**

* æŒæ¡ lock ä¸ synchronized çš„åŒºåˆ«
* ç†è§£ ReentrantLock çš„å…¬å¹³ã€éå…¬å¹³é”
* ç†è§£ ReentrantLock ä¸­çš„æ¡ä»¶å˜é‡

**ä¸‰ä¸ªå±‚é¢**

ä¸åŒç‚¹

* è¯­æ³•å±‚é¢
  * synchronized æ˜¯å…³é”®å­—ï¼Œæºç åœ¨ jvm ä¸­ï¼Œç”¨ c++ è¯­è¨€å®ç°
  * Lock æ˜¯æ¥å£ï¼Œæºç ç”± jdk æä¾›ï¼Œç”¨ java è¯­è¨€å®ç°
  * ä½¿ç”¨ synchronized æ—¶ï¼Œé€€å‡ºåŒæ­¥ä»£ç å—é”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä½¿ç”¨ Lock æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨ unlock æ–¹æ³•é‡Šæ”¾é”
* åŠŸèƒ½å±‚é¢
  * äºŒè€…å‡å±äºæ‚²è§‚é”ã€éƒ½å…·å¤‡åŸºæœ¬çš„äº’æ–¥ã€åŒæ­¥ã€é”é‡å…¥åŠŸèƒ½
    - æ‚²è§‚é”ï¼šä¸€ç§æ¯”è¾ƒä¿å®ˆ(æ‚²è§‚)çš„é”æœºåˆ¶ï¼Œå®ƒå‡è®¾åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä»»ä½•æ—¶å€™éƒ½å¯èƒ½ä¼šæœ‰å…¶ä»–çº¿ç¨‹å¯¹å…±äº«æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤åœ¨è®¿é—®å…±äº«æ•°æ®æ—¶ä¼šå…ˆè¿›è¡ŒåŠ é”ã€‚
    - ä¹è§‚é”ï¼šå®ƒå‡è®¾åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œæ•°æ®ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå› æ­¤åœ¨è®¿é—®å…±äº«æ•°æ®æ—¶ä¸ä¼šå¯¹å…¶è¿›è¡ŒåŠ é”ï¼Œè€Œæ˜¯é€šè¿‡ç‰ˆæœ¬æ§åˆ¶çš„æ–¹å¼æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®‰å…¨æ€§ã€‚
    - äº’æ–¥ï¼šå¤šä¸ªçº¿ç¨‹äº‰æŠ¢åŒä¸€æŠŠé”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸï¼Œå…¶ä»–çº¿ç¨‹éƒ½å¤±è´¥ï¼Œå¤±è´¥çš„é™·å…¥é˜»å¡çŠ¶æ€ã€‚
    - åŒæ­¥ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¿è¡Œä¸­éœ€è¦å…¶çº¿ç¨‹ç»“æœæ—¶ï¼Œè¦ç­‰å¾…é‚£ä¸ªçº¿ç¨‹çš„ç»“æœå†å¾€ä¸‹è¿è¡Œã€‚
      - å®ç°åŒæ­¥ï¼šsynchronizedå¯ä»¥ç”¨waitã€notifyæ¥å®ç°åŒæ­¥ã€‚Lockå¯ä»¥ç”¨æ¡ä»¶å˜é‡egï¼šsignal
    - é”é‡å…¥ï¼šæŒé”çš„çº¿ç¨‹èƒ½ä¸èƒ½å¯¹è¿™ä¸ªå¯¹è±¡é‡å¤åŠ é”ï¼Œegï¼šä¸€ä¸ªçº¿ç¨‹å·²ç»å¯¹ä¸€ä¸ªå¯¹è±¡åŠ ä¸Šé”äº†ï¼Œæ¥ä¸‹æ¥èƒ½ä¸èƒ½ç»§ç»­å¯¹å¯¹è±¡åŠ ç¬¬äºŒé“é”ã€ç¬¬ä¸‰é“é”ï¼Œå¯ä»¥åˆ™æ˜¯å¯é‡å…¥é”ã€‚åŠ å¤šå°‘åˆ°è§£é”å°±è¦è§£å¤šå°‘é“ã€‚
  * Lock æä¾›äº†è®¸å¤š synchronized ä¸å…·å¤‡çš„åŠŸèƒ½ï¼Œä¾‹å¦‚è·å–ç­‰å¾…çŠ¶æ€ã€å…¬å¹³é”ã€å¯æ‰“æ–­ã€å¯è¶…æ—¶ã€å¤šæ¡ä»¶å˜é‡
    - ç­‰å¾…çŠ¶æ€ï¼šeg:çº¿ç¨‹é˜»å¡çš„æ—¶å€™ï¼Œå¯ä»¥çŸ¥é“å“ªäº›çº¿ç¨‹é˜»å¡ä½äº†ã€‚ï¼ˆc++ååº•å±‚ï¼Œå®ç°èµ·æ¥ä¸æ˜“ï¼ŒLockç”¨javaå†™çš„ï¼Œæœ‰ç›¸åº”æ¥å£å¯å®ç°ï¼‰
    - å…¬å¹³é”ï¼šå¤šä¸ªçº¿ç¨‹äº‰æŠ¢é”å¤±è´¥åï¼Œå°†æ¥å†æŠ¢é”æ—¶ï¼Œæ˜¯å…ˆæ¥å…ˆå¾—è¿˜æ˜¯å¯ä»¥æ’é˜Ÿçš„ï¼Œå…ˆæ¥å…ˆå¾—å°±æ˜¯å…¬å¹³ï¼Œsynchronizedåªæ”¯æŒéå…¬å¹³é”ï¼ŒLockæ”¯æŒå…¬å¹³å’Œéå…¬å¹³ã€‚æ³¨ï¼šéå…¬å¹³é”æ•ˆç‡æ›´é«˜ã€‚
    - å¯æ‰“æ–­ï¼š ç­‰ä¸åˆ°é”å°±ä¸è¦è¿™ä¸ªé”äº†ã€‚å¯è¶…æ—¶ï¼šåœ¨æ—¶é—´å†…ç­‰ä¸åˆ°é”å°±ä¸è¦è¿™ä¸ªé”äº†ã€‚
    - å¤šæ¡ä»¶å˜é‡ï¼šå¤šä¸ªç­‰å¾…å¯¹åˆ—ã€‚synchronizedåªæœ‰ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œå³ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ŒLockæœ‰å¤šä¸ªã€‚
  * Lock æœ‰é€‚åˆä¸åŒåœºæ™¯çš„å®ç°ï¼Œå¦‚ ReentrantLockï¼ˆåŸºæœ¬çš„å¯é‡å…¥é”ï¼‰ï¼Œ ReentrantReadWriteLockï¼ˆé€‚åˆè¯»å¤šå†™å°‘ï¼‰ï¼Œsynchronizedåªæœ‰ä¸€ç§å®ç°ã€‚
* æ€§èƒ½å±‚é¢
  * åœ¨æ²¡æœ‰ç«äº‰/ç«äº‰å¾ˆå¤šå°‘æ—¶ï¼Œsynchronized åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå¦‚åå‘é”ã€è½»é‡çº§é”ï¼Œæ€§èƒ½ä¸èµ–
    - åå‘é”ï¼šåå‘é”çš„æ€è·¯æ˜¯åœ¨æ²¡æœ‰é”ç«äº‰çš„æƒ…å†µä¸‹ï¼ŒæŠŠå¯¹è±¡åå‘ç¬¬ä¸€ä¸ªè®¿é—®å®ƒçš„çº¿ç¨‹ï¼Œä½¿å¾—è¯¥çº¿ç¨‹åœ¨ä»¥åè®¿é—®åŒä¸€ä¸ªå¯¹è±¡æ—¶å¯ä»¥ä¸å¿…å†å»ç«äº‰é”ã€‚
    - è½»é‡çº§é”ï¼š
  * åœ¨ç«äº‰æ¿€çƒˆæ—¶ï¼ŒLock çš„å®ç°é€šå¸¸ä¼šæä¾›æ›´å¥½çš„æ€§èƒ½
**å…¬å¹³é”**

* å…¬å¹³é”çš„å…¬å¹³ä½“ç°
  * **å·²ç»å¤„åœ¨é˜»å¡é˜Ÿåˆ—**ä¸­çš„çº¿ç¨‹ï¼ˆä¸è€ƒè™‘è¶…æ—¶ï¼‰å§‹ç»ˆéƒ½æ˜¯å…¬å¹³çš„ï¼Œå…ˆè¿›å…ˆå‡º
  * å…¬å¹³é”æ˜¯æŒ‡**æœªå¤„äºé˜»å¡é˜Ÿåˆ—**ä¸­çš„çº¿ç¨‹æ¥äº‰æŠ¢é”ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™è€å®åˆ°é˜Ÿå°¾ç­‰å¾…
  * éå…¬å¹³é”æ˜¯æŒ‡**æœªå¤„äºé˜»å¡é˜Ÿåˆ—**ä¸­çš„çº¿ç¨‹æ¥äº‰æŠ¢é”ï¼Œä¸é˜Ÿåˆ—å¤´å”¤é†’çš„çº¿ç¨‹å»ç«äº‰ï¼Œè°æŠ¢åˆ°ç®—è°çš„
* å…¬å¹³é”ä¼šé™ä½ååé‡ï¼Œä¸€èˆ¬ä¸ç”¨

**æ¡ä»¶å˜é‡**

* ReentrantLock ä¸­çš„æ¡ä»¶å˜é‡åŠŸèƒ½ç±»ä¼¼äºæ™®é€š synchronized çš„ waitï¼Œnotifyï¼Œç”¨åœ¨å½“çº¿ç¨‹è·å¾—é”åï¼Œå‘ç°æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œä¸´æ—¶ç­‰å¾…çš„é“¾è¡¨ç»“æ„ã€‚egï¼šæ­¤æ—¶t2è·å¾—é”ï¼Œä½†æ˜¯ä¸å…·å¤‡å¾€ä¸‹è¿è¡Œçš„æ¡ä»¶å‚æ•°ï¼Œæ­¤æ—¶å¯ä»¥c2.await()ï¼Œæ”¾åˆ°c2çš„waiting queueé˜Ÿåˆ—ä¸­ã€‚åé¢æ¡ä»¶æ»¡è¶³å¯ä»¥ç»§ç»­è¿è¡Œæ—¶ï¼Œå¯ä»¥c2.signal()å”¤é†’c2ä¸­waiting queueé˜Ÿåˆ—çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’åçš„çº¿ç¨‹è¿›å…¥åˆ°blocked queueå°¾ç«¯ã€‚
* ä¸ synchronized çš„ç­‰å¾…é›†åˆä¸åŒä¹‹å¤„åœ¨äºï¼ŒReentrantLock ä¸­çš„æ¡ä»¶å˜é‡å¯ä»¥æœ‰å¤šä¸ªï¼Œå¯ä»¥å®ç°æ›´ç²¾ç»†çš„ç­‰å¾…ã€å”¤é†’æ§åˆ¶
>[ä»£ç ç¤ºä¾‹ğŸ‘ˆ](https://github.com/Fengleitown/BLOG-code/tree/main/src/main/java/day02)ä¸­TestReentrantLock

## 5. volatile

é¢è¯•é¢˜ï¼švolatileèƒ½å¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ

1.çº¿ç¨‹å®‰å…¨è¦è€ƒè™‘ä¸‰ä¸ªæ–¹é¢ï¼š**å¯è§æ€§ã€æœ‰åºæ€§ã€åŸå­æ€§**ã€‚

- å¯è§æ€§æŒ‡ï¼šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡ä¿®æ”¹ï¼Œå¦ä¸€çº¿ç¨‹èƒ½çœ‹åˆ°æœ€æ–°çš„ç»“æœã€‚
- æœ‰åºæ€§æŒ‡ï¼šä¸€ä¸ªçº¿ç¨‹å†…ä»£ç æŒ‰ç¼–å†™é¡ºåºæ‰§è¡Œ
- åŸå­æ€§æŒ‡ï¼šä¸€ä¸ªçº¿ç¨‹å†…å¤šè¡Œä»£ç ä»¥ä¸€ä¸ªæ•´ä½“è¿è¡Œï¼ŒæœŸé—´ä¸èƒ½æœ‰å…¶å®ƒçº¿ç¨‹ä»£ç æ’é˜Ÿ

2.volatileèƒ½ä¿è¯å…±äº«å˜é‡çš„å¯è§æ€§ä¸æœ‰åºæ€§ï¼Œä½†å¹¶ä¸èƒ½ä¿è¯åŸå­æ€§

**åŸå­æ€§**
* èµ·å› ï¼šå¤šçº¿ç¨‹ä¸‹ï¼Œä¸åŒçº¿ç¨‹çš„**æŒ‡ä»¤å‘ç”Ÿäº†äº¤é”™**å¯¼è‡´çš„å…±äº«å˜é‡çš„è¯»å†™æ··ä¹±
* è§£å†³ï¼šç”¨æ‚²è§‚é”æˆ–ä¹è§‚é”è§£å†³ï¼Œvolatile å¹¶ä¸èƒ½è§£å†³åŸå­æ€§

**å¯è§æ€§**

* èµ·å› ï¼šç”±äº**ç¼–è¯‘å™¨ä¼˜åŒ–ã€æˆ–ç¼“å­˜ä¼˜åŒ–ã€æˆ– CPU æŒ‡ä»¤é‡æ’åºä¼˜åŒ–**å¯¼è‡´çš„å¯¹å…±äº«å˜é‡æ‰€åšçš„ä¿®æ”¹å¦å¤–çš„çº¿ç¨‹çœ‹ä¸åˆ°
* è§£å†³ï¼šç”¨ volatile ä¿®é¥°å…±äº«å˜é‡ï¼Œèƒ½å¤Ÿé˜²æ­¢ç¼–è¯‘å™¨ç­‰ä¼˜åŒ–å‘ç”Ÿï¼Œè®©ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§

**æœ‰åºæ€§**

* èµ·å› ï¼šç”±äº**ç¼–è¯‘å™¨ä¼˜åŒ–ã€æˆ–ç¼“å­˜ä¼˜åŒ–ã€æˆ– CPU æŒ‡ä»¤é‡æ’åºä¼˜åŒ–**å¯¼è‡´æŒ‡ä»¤çš„å®é™…æ‰§è¡Œé¡ºåºä¸ç¼–å†™é¡ºåºä¸ä¸€è‡´
* è§£å†³ï¼šç”¨ volatile ä¿®é¥°å…±äº«å˜é‡ä¼šåœ¨è¯»ã€å†™å…±äº«å˜é‡æ—¶åŠ å…¥ä¸åŒçš„å±éšœï¼Œé˜»æ­¢å…¶ä»–è¯»å†™æ“ä½œè¶Šè¿‡å±éšœï¼Œä»è€Œè¾¾åˆ°é˜»æ­¢é‡æ’åºçš„æ•ˆæœ
* æ³¨æ„ï¼š
  * **volatile å˜é‡å†™**åŠ çš„å±éšœæ˜¯é˜»æ­¢ä¸Šæ–¹å…¶å®ƒå†™æ“ä½œè¶Šè¿‡å±éšœæ’åˆ° **volatile å˜é‡å†™**ä¹‹ä¸‹
  * **volatile å˜é‡è¯»**åŠ çš„å±éšœæ˜¯é˜»æ­¢ä¸‹æ–¹å…¶å®ƒè¯»æ“ä½œè¶Šè¿‡å±éšœæ’åˆ° **volatile å˜é‡è¯»**ä¹‹ä¸Š
  * volatile è¯»å†™åŠ å…¥çš„å±éšœåªèƒ½é˜²æ­¢åŒä¸€çº¿ç¨‹å†…çš„æŒ‡ä»¤é‡æ’

> ***ä»£ç è¯´æ˜***

>[ä»£ç ç¤ºä¾‹ğŸ‘ˆ](https://github.com/Fengleitown/BLOG-code/tree/main/src/main/java/day02.threadsafe)ä¸­AddAndSubtract æ¼”ç¤ºåŸå­æ€§
>[ä»£ç ç¤ºä¾‹ğŸ‘ˆ](https://github.com/Fengleitown/BLOG-code/tree/main/src/main/java/day02.threadsafe)ä¸­ForeverLoop æ¼”ç¤ºå¯è§æ€§
>       æ³¨æ„ï¼šæœ¬ä¾‹ç»å®è·µæ£€éªŒæ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–å¯¼è‡´çš„å¯è§æ€§é—®é¢˜
>[ä»£ç ç¤ºä¾‹ğŸ‘ˆ](https://github.com/Fengleitown/BLOG-code/tree/main/src/main/java/day02.threadsafe)ä¸­Reordering æ¼”ç¤ºæœ‰åºæ€§
>  * éœ€è¦æ‰“æˆ jar åŒ…åæµ‹è¯•
>* [å¯åŒæ—¶å‚è€ƒè§†é¢‘è®²è§£ğŸ‘ˆ](https://www.bilibili.com/video/BV15b4y117RJ?p=79&vd_source=add76bce03794ff30f98753a5213643b)



volatileæ˜¯ä½¿ç”¨`å†…å­˜å±éšœ`æ¥è§£å†³æŒ‡ä»¤é‡æ’åºï¼Œä½¿ç”¨volatileä¿®é¥°å˜é‡åï¼Œè¯»å’Œå†™çš„æ“ä½œä¼šåˆ†åˆ«åŠ å…¥ä¸åŒçš„å†…å­˜å±éšœã€‚è¯»æ—¶ï¼Œå†…å­˜å±éšœæ˜¯è¿™æ ·çš„âˆ¨,é˜»æ­¢ä¸Šé¢çš„ä»£ç è¶Šè¿‡å±éšœæ’ä¸Šå»ï¼Œå†™æ—¶,å†…å­˜å±éšœæ˜¯è¿™æ ·âˆ§ï¼Œé˜»æ­¢ä¸‹é¢ä»£ç è¶Šè¿‡å±éšœæ’ä¸‹æ¥ã€‚æ‰€ä»¥ç”¨volatileå…³é”®å­—ä¿®é¥°å˜é‡æ—¶ï¼Œå¦‚æœæ˜¯è¯»æ“ä½œï¼Œä¿®é¥°ä¸‹é¢çš„å˜é‡ï¼Œå†™æ“ä½œï¼Œä¿®é¥°ä¸Šé¢çš„å˜é‡ã€‚

eg: x=1;													volatile x=1;

â€‹	volatile  y=1;		è¿™æ˜¯è¯»æ“ä½œ		    y=1;		  		è¿™æ˜¯å†™æ“ä½œ

## 6. æ‚²è§‚é” vs ä¹è§‚é”

**è¦æ±‚**

* æŒæ¡æ‚²è§‚é”å’Œä¹è§‚é”çš„åŒºåˆ«

**å¯¹æ¯”æ‚²è§‚é”ä¸ä¹è§‚é”**

* æ‚²è§‚é”çš„ä»£è¡¨æ˜¯ synchronized å’Œ Lock é”
  * å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ã€çº¿ç¨‹åªæœ‰å æœ‰äº†é”ï¼Œæ‰èƒ½å»æ“ä½œå…±äº«å˜é‡ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å é”æˆåŠŸï¼Œè·å–é”å¤±è´¥çš„çº¿ç¨‹ï¼Œéƒ½å¾—åœä¸‹æ¥ç­‰å¾…ã€‘
  * çº¿ç¨‹ä»è¿è¡Œåˆ°é˜»å¡ã€å†ä»é˜»å¡åˆ°å”¤é†’ï¼Œæ¶‰åŠçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¦‚æœé¢‘ç¹å‘ç”Ÿï¼Œå½±å“æ€§èƒ½
  * å®é™…ä¸Šï¼Œçº¿ç¨‹åœ¨è·å– synchronized å’Œ Lock é”æ—¶ï¼Œå¦‚æœé”å·²è¢«å ç”¨ï¼Œéƒ½ä¼šåšå‡ æ¬¡é‡è¯•æ“ä½œï¼Œ`å‡å°‘é˜»å¡`çš„æœºä¼š

* ä¹è§‚é”çš„ä»£è¡¨æ˜¯ AtomicIntegerï¼Œä½¿ç”¨ cas æ¥ä¿è¯åŸå­æ€§

  * å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ã€æ— éœ€åŠ é”ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸä¿®æ”¹å…±äº«å˜é‡ï¼Œå…¶å®ƒå¤±è´¥çš„çº¿ç¨‹ä¸éœ€è¦åœæ­¢ï¼Œä¸æ–­é‡è¯•ç›´è‡³æˆåŠŸã€‘
  * ç”±äºçº¿ç¨‹ä¸€ç›´è¿è¡Œï¼Œä¸éœ€è¦é˜»å¡ï¼Œå› æ­¤ä¸æ¶‰åŠçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢
  * å®ƒéœ€è¦å¤šæ ¸ cpu æ”¯æŒï¼Œä¸”çº¿ç¨‹æ•°ä¸åº”è¶…è¿‡ cpu æ ¸æ•°

CASä¸€èˆ¬å’Œvolatileä¸€èµ·ä½¿ç”¨ã€‚ä¸»è¦æ–¹æ³•å°±æ˜¯

```java
account:ä¸€ä¸ªå¯¹è±¡	BALANCE:é™æ€å˜é‡	old:æ—§å€¼	news:æ–°å€¼	
U.compareAndSetInt(account, BALANCE, old, news)
//é˜²æ­¢å¤šçº¿ç¨‹æƒ…å†µä¸‹é™æ€å˜é‡è¢«ç¯¡æ”¹æˆ–è€…æ˜¯è¦†ç›–æ–°å€¼ï¼Œå°±å¼•ç”¨äº†è¿™ä¸ªæ–¹æ³•.
//æ‹¿åˆ°é™æ€å˜é‡balanceçš„å€¼ï¼Œä¸oldå¤šæ¯”è¾ƒï¼Œç›¸åŒåˆ™è¯´æ˜æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ¥æ”¹å˜é™æ€å˜é‡çš„å€¼ã€‚åˆ™æˆ‘å¯ä»¥ä¿®æ”¹æˆåŠŸã€‚
//å¦‚æœæ‹¿åˆ°é™æ€å˜é‡balanceçš„å€¼!=oldï¼Œåˆ™compareAndSetInt()å°±ä¿®æ”¹å¤±è´¥
```

>[ä»£ç ç¤ºä¾‹ğŸ‘ˆ](https://github.com/Fengleitown/BLOG-code/tree/main/src/main/java/day02)ä¸­SyncVsCas